---
title: 'ESM 204: HW4'
author: "Patrick Pelegri-O'Day"
date: "5/18/2022"
output:
  html_document: 
    theme: flatly
    highlight: pygments
    code_folding: hide
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(scales)
library(broom)
library(patchwork)
```

```{r}
damages_df <- read_csv(here("data", "damages.csv")) %>% 
  clean_names()
warming_df <- read_csv(here('data', 'warming.csv')) %>% 
  clean_names() %>% 
  select(-x1)
``` 

### Question 1

```{r}
# Create vector of squared temperature for quadratic model
damages_df$warming2 <- damages_df$warming^2

# Define quadratic model for climate damages with 0 intercept
damages_lm <- lm(damages ~ 0 + warming + warming2, data = damages_df)

# Predict damages
damages_predict <- predict(damages_lm)

# Add predicted values to damages_df
damages_df <- damages_df %>% 
  mutate(predicted_damages = damages_predict)
```

```{r}
# Plot predicted damages
ggplot(data = damages_df, aes(x = warming)) + 
  geom_point(aes(y = damages), size = 1, color = 'gray70') +
  geom_line(aes(y = predicted_damages), size = 0.8, color = 'steelblue4') +
  theme_minimal() + 
  # scale_y_continuous(labels = comma) + # would convert scale but then it's unreadable
  labs(x = 'Warming (C)', y = 'Damages (USD)')
```

**Figure 1.** Estimated damages (USD) per unit of additional warming (Celsius) using a quadratic regression.


### Question 2

```{r}
# Create tidy version of model so it's easier to call values
damages_lm_tidy <- tidy(damages_lm)
```

```{r}
# Create damages function
damages_func <- function(temp){
  damages = damages_lm_tidy$estimate[1]*(temp) + damages_lm_tidy$estimate[2]*((temp)^2)
  return(damages)
}
```

```{r}
# PREP FOR Q2 PLOTS

# Create columns of damages for baseline and pulse based on damages function calculated above
warming_df <- warming_df %>% 
  mutate(damages_baseline = damages_func(warming_baseline)) %>% 
  mutate(damages_pulse = damages_func(warming_pulse))

# Create column of additional damages from the pulse
warming_df <- warming_df %>% 
  mutate(damages_addtl = damages_pulse - damages_baseline)

# Create column of additional damages from the pulse *per ton of CO2*
warming_df <- warming_df %>% 
  mutate(damages_addtl_perton = (damages_pulse - damages_baseline)/(35*10^9))
```

```{r}
# Q2 plots

# Plot of damages under baseline
baseline_dmg_plot <- ggplot(warming_df, aes(x = year, y = damages_baseline)) +
  geom_line() +
  theme_minimal() +
  labs(x = 'Year', y = 'Damages (USD)', title = 'Damages under baseline')

# Plot of damages under pulse
pulse_dmg_plot <- ggplot(warming_df, aes(x = year, y = damages_pulse)) +
  geom_line() +
  theme_minimal() +
  labs(x = 'Year', y = 'Damages (USD)', title = 'Damages with pulse')

# Plot of additional damages from pulse
addtl_dmg_plot <- ggplot(warming_df, aes(x = year, y = damages_addtl)) +
  geom_line() +
  theme_minimal() +
  labs(x = 'Year', y = 'Damages (USD)', title = 'Additional damages from pulse')

# Plot of additional damages from pulse per ton of CO2
addtl_dmg_perton_plot <- ggplot(warming_df, aes(x = year, y = damages_addtl_perton)) +
  geom_line() +
  theme_minimal() +
  labs(x = 'Year', y = 'Damages (USD)', title = 'Additional damages from pulse \n per ton of CO2')

q2_plots <- (baseline_dmg_plot + pulse_dmg_plot)/(addtl_dmg_plot + addtl_dmg_perton_plot)
q2_plots
```

**Figure 2.** Estimation of climate damages under different scenarios.

### Question 3

```{r}
# BUILD UP TO DF OF SCC & DISCOUNT RATES

# Create function of damages in present value based on year based on warming_df
addtl_dmg_pv_func <- function(addtl_dmg, r){
  addtl_dmg_pv = sum(addtl_dmg/((1+r)^c(1:length(addtl_dmg))))
  return(addtl_dmg_pv)
}

# Define terms for use in function above
addtl_dmg <- warming_df$damages_addtl_perton 
r <- seq(0, 0.1, 0.005) # Calculate for r (discount rate) values from 0 to 10% in 0.5% increments
scc <- numeric() # Create empty vector for scc values to be put into

# Create vector scc that contains scc values at different discount rates
for(i in 1:length(r)){
  scc[i] <- addtl_dmg_pv_func(addtl_dmg,r[i])
}

# Make df of scc values and discount rates
scc_df <- data.frame(scc) %>% 
  mutate(discount_rate_pct = 100*r)
```

```{r}
# Plot scc against discount rate
ggplot(scc_df, aes(x = discount_rate_pct, y = scc)) +
  geom_line() +
  theme_minimal() + 
  labs(x = 'Discount rate (percentage)', y = 'Social Cost of Carbon (USD)')
```

**Figure 3.** Social cost of carbon per discount rate.

**Explanation:** The SCC decreases as the discount rate increases because the SCC is based on the present value of future climate-related damages from greenhouse gas emissions. The higher the discount rate, the lower the cost of future damages in present-day terms.

### Question 4

The Ramsey Rule is r = p + ng

```{r}
scc_0.021dr <- addtl_dmg_pv_func(addtl_dmg, 0.021)
```

Given p = 0.001, n = 2, and g = 0.01, r = 0.021. This corresponds to an SCC of `r round(scc_0.021dr, 1)`

Figure 3 is reproduced below with this point highlighted.

```{r}
# Create df with the Ramsey Rule point for plotting
ramsey_rule_v <- c(69.88626, 2.1)
ramsey_rule_df <- scc_df %>%
  rbind(ramsey_rule_v) %>%
  filter(discount_rate_pct == 2.1)
```

```{r}
# Plot scc against discount rate
ggplot() +
  geom_point(data = ramsey_rule_df, 
             aes(x = discount_rate_pct, y = scc),
             color = 'violetred4',
             size = 2.5) +
 annotate("text", x = 3.15, y = 77, label = "Highlighted SCC") +
 geom_line(data = scc_df,
           aes(x = discount_rate_pct, y = scc)) +
  theme_minimal() + 
  labs(x = 'Discount rate (percentage)', y = 'Social Cost of Carbon (USD)')
```

**Figure 4.** Social cost of carbon (SCC) per discount rate, with the SCC for a discount rate based on the Ramsey Rule highlighted.
